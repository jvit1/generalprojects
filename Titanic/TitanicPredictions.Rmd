```{r warning=FALSE, include=FALSE}
library(tidyverse)
library(tidymodels)
library(modelr)
library(randomForest)
library(ggplot2)
library(knitr)
train <- read.csv("C:/Users/student/Documents/UVA/Portfolio Projects/generalprojects/Titanic/train.csv")
test <- read.csv("C:/Users/student/Documents/UVA/Portfolio Projects/generalprojects/Titanic/test.csv")
```

## Exploratory
Let's take a look into the data.
```{r}
str(train)
```
As we can see, our response variable (survived) isn't currently a factor. This will cause some issues later down the road, so let's address it now as well as making some other general changes. Of course, I'm changing these just based on 'gut' feeling, so I might have to change them back later on.
```{r}
train$Sex <- as.factor(train$Sex)
train$Survived <- as.factor(train$Survived)
train$Pclass <- as.factor(train$Pclass)
train$Embarked <- as.factor(train$Embarked)
train$SibSp <- as.factor(train$SibSp)
train$Parch <- as.factor(train$Parch)


train$Embarked[train$Embarked==""]<-"Any text, NA will be generated"
train$Cabin[train$Cabin==""]<-NA
```

Let's look to see if there's any missing values.
```{r}
colSums(is.na(train))
```
We've got some to deal with. Let's get into a visual analysis to see if it's worth trying to estimate these missing values.

### Visual
To start, let's take a look at age and sex to see how those play into who lives.
```{r}
#Sex
train %>% select(Survived, Sex) %>%
  ggplot() + geom_bar(aes(x=Sex, fill = Survived))
```
It's clear to see that women survive at higher rates than men do.

```{r}
#Age
train %>% select(Survived, Age) %>%
  ggplot() + geom_histogram(aes(x=Age, fill = Survived))
```

Stopped here 5/29



For age, we'll try out inputting the median age of 28, which is found below.
```{r}
train %>% select(Age) %>% summarise(median=median(Age, na.rm=TRUE))
train$Age[is.na(train$Age)] <- 28
```

Let's try running a random forest initially. We may need to predict age later on.
```{r}
train.clean <- train %>% select(-Name, -PassengerId)
RF.1 <- randomForest(Survived ~ . , data = train.clean,
                     mtry = 2, importance= TRUE)

RF.1 %>% importance
```

Now we'll go head and add these to the data then assess the accuracy.
```{r}
#Adding to data
RF.add1 <- train.clean %>%
  add_predictions(RF.1) %>%
  rename(pred_pct = pred) %>%
  mutate(method = "RF.1") %>%
  mutate(prediction = ifelse(pred_pct > .5, 1,0))

RF.add1$Survived <- as.factor(RF.add1$Survived)
RF.add1$prediction <- as.factor(RF.add1$prediction)


#Assessments
RF.add1 %>%
  conf_mat(truth = Survived, estimate = prediction)

RF.add1 %>%
  metrics(truth = Survived, estimate = prediction) %>%
  filter(.metric == "accuracy")
```

Not bad. Let's apply this to the testing data. First, we have to fill the missing values.
```{r}
test %>% select(Age) %>% summarise(median=median(Age, na.rm=TRUE))
test$Age[is.na(test$Age)] <- 27

test %>% select(Fare) %>% summarise(median=median(Fare, na.rm=TRUE))
test$Fare[is.na(test$Fare)] <- 14.4542
```


```{r}
RF.test <- test %>%
  add_predictions(RF.1) %>%
  rename(pred_pct = pred) %>%
  mutate(method = "RF.1") %>%
  mutate(prediction = ifelse(pred_pct > .5, 1,0))

final.results <- RF.test %>%
  select(PassengerId, prediction) %>%
  rename(Survived = prediction)

write.csv(final.results, 'C:/Users/student/Documents/UVA/Portfolio Projects/generalprojects/Titanic/results.csv' , row.names=FALSE)
```

