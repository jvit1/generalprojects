```{r}
library(tidyverse)
library(tidymodels)
library(modelr)
library(randomForest)
train <- read.csv("C:/Users/student/Desktop/titanic/train.csv")
```

```{r}
## Modify data:
## 1. Create response variable: 
##      Has the bike retained at least 80%, between 50% and 80%, or below 50% of the showroom price?
## 2. Remove name variable and variables used to create response variable
## 3. Remove all makes that have fewer than 3 observations
## 4. Remove all rows with any NAs
train <- train %>% select(-Name) %>% drop_na()


## Build random forest
## Without basic_model for computing power
## Two variables are eligible for a split at each node
RF.mod1 <- randomForest(Survived ~ ., data = train,
                        mtry = 2, importance = TRUE)


## Random forest information
## No. of variables shows the number of variables available for each split
## OOB estimate of error rate is an estimate of misclassification
## Misclassification error shown for each level with confusion matrix
RF.mod1


## Importance of predictor variables
## The values show the percent decrease in the following measures when each variable is not 
## available for a split 
##   a. prediction accuracy for each level of the response variable
##   b. overall prediction accuracy
##   c. node purity
RF.mod1 %>% 
  importance()


## Build random forest without seller_type
RF.mod2 <- randomForest(Survived ~ Pclass + Sex + Age + Fare, data = train,
                        mtry = 2, importance = TRUE)


## Random forest information
RF.mod2

RF.mod2 %>% 
  importance()

## Add predicted values to VALIDATION data
## Change default column names
## Potential issue: 
##   When the data is split, it is possible that a category that is present in one set is not 
##   present in other sets. In this case, prediction will not work.
RF.add1 <- train %>%
  add_predictions(RF.mod1) %>%
  rename(pred_value = pred) %>%
  mutate(method = "RF.mod1")

RF.add2 <- train %>%
  add_predictions(RF.mod2) %>%
  rename(pred_value = pred) %>%
  mutate(method = "RF.mod2")


## Combine prediction information
RF.add <- RF.add1 %>%
  bind_rows(RF.add2) %>%
  group_by(method)


## Confusion matrix
## Use validation data
RF.add1 %>%
  conf_mat(truth = value, estimate = pred_value)

RF.add2 %>%
  conf_mat(truth = value, estimate = pred_value)


## Accuracy rate
## Use validation data
RF.add %>%
  metrics(truth = Survived, estimate = pred_value) %>%
  filter(.metric == "accuracy")
```

